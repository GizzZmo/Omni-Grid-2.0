name: Workflow Status

on:
  workflow_run:
    workflows: ["CI", "CodeQL Security Scan", "Dependency Audit", "Performance Check"]
    types:
      - completed
  workflow_dispatch:

jobs:
  status-summary:
    name: Generate Status Summary
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate workflow status
        uses: actions/github-script@v7
        with:
          script: |
            const workflows = ['CI', 'CodeQL Security Scan', 'Dependency Audit', 'Performance Check'];
            let summary = '# üö¶ Workflow Status Dashboard\n\n';
            summary += `> Last updated: ${new Date().toUTCString()}\n\n`;
            summary += '## Current Status\n\n';
            
            for (const workflow of workflows) {
              try {
                const runs = await github.rest.actions.listWorkflowRunsForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  per_page: 1,
                  status: 'completed'
                });
                
                if (runs.data.workflow_runs.length > 0) {
                  const run = runs.data.workflow_runs[0];
                  const status = run.conclusion === 'success' ? '‚úÖ' : '‚ùå';
                  const badge = run.conclusion === 'success' ? 'üü¢' : 'üî¥';
                  summary += `${badge} **${workflow}**: ${status} ${run.conclusion}\n`;
                } else {
                  summary += `‚ö™ **${workflow}**: No runs found\n`;
                }
              } catch (error) {
                summary += `‚ö†Ô∏è **${workflow}**: Error fetching status\n`;
              }
            }
            
            summary += '\n---\n\n';
            summary += '## Quick Links\n\n';
            summary += '- [All Workflows](../../actions)\n';
            summary += '- [Latest Release](../../releases/latest)\n';
            summary += '- [Security Advisories](../../security/advisories)\n';
            summary += '- [Dependency Graph](../../network/dependencies)\n';
            
            console.log(summary);
            core.summary.addRaw(summary).write();
