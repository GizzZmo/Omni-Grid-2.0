name: Workflow Status

on:
  workflow_run:
    workflows: ["CI", "CodeQL Security Scan", "Dependency Audit", "Performance Check"]
    types:
      - completed
  workflow_dispatch:

permissions:
  actions: read
  contents: read

jobs:
  status-summary:
    name: Generate Status Summary
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Generate workflow status
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const workflows = ['CI', 'CodeQL Security Scan', 'Dependency Audit', 'Performance Check'];
            let summary = '# ðŸš¦ Workflow Status Dashboard\n\n';
            summary += `> Last updated: ${new Date().toUTCString()}\n\n`;
            summary += '## Current Status\n\n';
            summary += '| Workflow | Status | Conclusion | Run Date |\n';
            summary += '|----------|--------|------------|----------|\n';
            
            for (const workflow of workflows) {
              try {
                // Get all workflows and find the specific one by name
                const workflowsList = await github.rest.actions.listRepoWorkflows({
                  owner: context.repo.owner,
                  repo: context.repo.repo
                });
                
                const workflowInfo = workflowsList.data.workflows.find(w => w.name === workflow);
                
                if (workflowInfo) {
                  const runs = await github.rest.actions.listWorkflowRuns({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    workflow_id: workflowInfo.id,
                    per_page: 1
                  });
                  
                  if (runs.data.workflow_runs.length > 0) {
                    const run = runs.data.workflow_runs[0];
                    const statusIcon = run.conclusion === 'success' ? 'âœ…' : 
                                      run.conclusion === 'failure' ? 'âŒ' : 
                                      run.conclusion === 'cancelled' ? 'âšª' : 'â³';
                    const runDate = new Date(run.created_at).toLocaleDateString();
                    summary += `| ${workflow} | ${statusIcon} | ${run.conclusion || 'running'} | ${runDate} |\n`;
                  } else {
                    summary += `| ${workflow} | âšª | No runs | N/A |\n`;
                  }
                } else {
                  summary += `| ${workflow} | âš ï¸ | Not found | N/A |\n`;
                }
              } catch (error) {
                console.error(`Error fetching status for ${workflow}:`, error.message);
                summary += `| ${workflow} | âš ï¸ | Error | N/A |\n`;
              }
            }
            
            summary += '\n---\n\n';
            summary += '## ðŸ“Š Repository Health\n\n';
            
            try {
              // Get latest commit
              const { data: commits } = await github.rest.repos.listCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 1
              });
              
              if (commits.length > 0) {
                summary += `- **Latest Commit**: ${commits[0].sha.substring(0, 7)} - ${commits[0].commit.message.split('\n')[0]}\n`;
                summary += `- **Committed**: ${new Date(commits[0].commit.author.date).toLocaleString()}\n`;
              }
            } catch (error) {
              console.error('Error fetching commits:', error.message);
            }
            
            try {
              // Get open issues and PRs
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                per_page: 1
              });
              
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                per_page: 1
              });
              
              summary += `- **Open Issues**: ${issues.length}\n`;
              summary += `- **Open PRs**: ${prs.length}\n`;
            } catch (error) {
              console.error('Error fetching issues/PRs:', error.message);
            }
            
            summary += '\n---\n\n';
            summary += '## ðŸ”— Quick Links\n\n';
            summary += '- [All Workflows](../../actions)\n';
            summary += '- [Latest Release](../../releases/latest)\n';
            summary += '- [Security Advisories](../../security/advisories)\n';
            summary += '- [Dependency Graph](../../network/dependencies)\n';
            summary += '- [Documentation](../../wiki)\n';
            
            console.log(summary);
            core.summary.addRaw(summary).write();
